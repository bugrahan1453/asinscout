<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testimonials - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#0a0a0f;--bg2:#12121a;--bg3:#1a1a25;--text:#f0f0f5;--text2:#9898a8;--orange:#ff6b2c;--pink:#ff2c6b;--green:#22c97a;--red:#ff4d5e;--border:#2a2a35}
        body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text)}
        .sidebar{position:fixed;left:0;top:0;bottom:0;width:260px;background:var(--bg2);border-right:1px solid var(--border);padding:20px}
        .sidebar-logo{display:flex;align-items:center;gap:10px;font-size:18px;font-weight:800;margin-bottom:10px;color:var(--text);text-decoration:none}
        .sidebar-logo span{color:var(--orange)}
        .sidebar-logo .icon{width:36px;height:36px;background:linear-gradient(135deg,var(--pink),var(--orange));border-radius:10px;display:flex;align-items:center;justify-content:center}
        .admin-badge{font-size:10px;background:var(--red);color:#fff;padding:2px 8px;border-radius:4px;margin-bottom:30px;display:inline-block}
        .sidebar-menu{list-style:none}
        .sidebar-menu a{display:block;padding:12px 16px;color:var(--text2);text-decoration:none;border-radius:10px;margin-bottom:4px}
        .sidebar-menu a:hover,.sidebar-menu a.active{background:var(--bg3);color:var(--text)}
        .sidebar-menu a.active{background:linear-gradient(135deg,rgba(255,107,44,0.2),rgba(255,44,107,0.1));color:var(--orange)}
        .main{margin-left:260px;padding:30px}
        .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
        .page-title{font-size:28px;font-weight:700}
        .card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px}
        table{width:100%;border-collapse:collapse}
        th,td{text-align:left;padding:14px;border-bottom:1px solid var(--border)}
        th{color:var(--text2);font-size:12px;text-transform:uppercase}
        tr:hover{background:var(--bg3)}
        .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s}
        .btn-primary{background:var(--orange);color:#fff}
        .btn-primary:hover{background:#ff8550}
        .btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
        .btn-outline:hover{border-color:var(--orange);color:var(--orange)}
        .btn-sm{padding:6px 12px;font-size:12px}
        .btn-danger{background:var(--red);color:#fff}
        .btn-danger:hover{background:#ff6b7a}
        .badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600}
        .badge.green{background:rgba(34,201,122,0.15);color:var(--green)}
        .badge.red{background:rgba(255,77,94,0.15);color:var(--red)}
        .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:30px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
        .modal-title{font-size:22px;font-weight:700;margin-bottom:24px}
        .form-group{margin-bottom:20px}
        .form-group label{display:block;font-size:13px;color:var(--text2);margin-bottom:8px}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px}
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--orange)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .form-check{display:flex;align-items:center;gap:10px}
        .form-check input{width:auto}
        .modal-actions{display:flex;gap:12px;margin-top:24px}
        .modal-actions .btn{flex:1}
        .empty{text-align:center;padding:60px;color:var(--text2)}
        .loading{text-align:center;padding:40px;color:var(--text2)}
        .testimonial-text{max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .avatar-preview{width:40px;height:40px;background:var(--orange);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px}
        .stars{color:#ffc107}
        .mobile-toggle{display:none;position:fixed;top:12px;left:12px;z-index:1001;background:var(--bg2,#12121a);border:1px solid var(--border,#2a2a35);border-radius:8px;padding:8px 12px;color:var(--text,#f0f0f5);font-size:18px;cursor:pointer}
        .sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:999}
        @media(max-width:768px){.mobile-toggle{display:block}.sidebar{transform:translateX(-100%);transition:transform 0.3s;z-index:1000}.sidebar.open{transform:translateX(0)}.main{margin-left:0}.sidebar-overlay.active{display:block}}
        .lang-switch{position:absolute;top:20px;right:20px;display:flex;gap:6px}
        .lang-btn{padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg3);color:var(--text2);cursor:pointer;font-size:12px}
        .lang-btn.active{background:var(--orange);color:#fff;border-color:var(--orange)}
    </style>
</head>
<body>
<button class="mobile-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open');document.querySelector('.sidebar-overlay').classList.toggle('active')">&#9776;</button>
<div class="sidebar-overlay" onclick="document.querySelector('.sidebar').classList.remove('open');this.classList.remove('active')"></div>
    <aside class="sidebar">
        <a href="../index.html" class="sidebar-logo"><div class="icon">A</div>ASIN<span>Scout</span></a>
        <div class="admin-badge">ADMIN</div>
        <ul class="sidebar-menu">
            <a href="index.html">üìä <span data-i18n="admin_dashboard">Dashboard</span></a>
            <a href="users.html">üë• <span data-i18n="admin_users">Users</span></a>
            <a href="packages.html">üì¶ <span data-i18n="admin_packages">Packages</span></a>
            <a href="orders.html">üí≥ <span data-i18n="admin_orders">Orders</span></a>
            <a href="discounts.html">üè∑Ô∏è <span data-i18n="admin_discounts">Discounts</span></a>
            <a href="affiliates.html">ü§ù <span data-i18n="admin_affiliates">Affiliates</span></a>
            <a href="testimonials.html" class="active">üí¨ <span data-i18n="admin_testimonials">Testimonials</span></a>
            <a href="logs.html">üêõ <span data-i18n="admin_logs">Error Logs</span></a>
            <a href="settings.html">‚öôÔ∏è <span data-i18n="admin_settings">Settings</span></a>
            <a href="#" onclick="logout()">üö™ <span data-i18n="admin_logout">Logout</span></a>
        </ul>
        <div class="lang-switch">
            <button class="lang-btn" data-lang="en" onclick="setLanguage('en')">EN</button>
            <button class="lang-btn" data-lang="tr" onclick="setLanguage('tr')">TR</button>
        </div>
    </aside>

    <main class="main">
        <div class="page-header">
            <h1 class="page-title">üí¨ <span data-i18n="admin_testimonials_title">Testimonials</span></h1>
            <button class="btn btn-primary" onclick="openModal()" data-i18n="admin_testimonial_add">+ Add Testimonial</button>
        </div>

        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Avatar</th>
                        <th data-i18n="admin_testimonial_name">Name</th>
                        <th data-i18n="admin_testimonial_role">Role</th>
                        <th data-i18n="admin_testimonial_text">Comment</th>
                        <th data-i18n="admin_testimonial_rating">Rating</th>
                        <th data-i18n="admin_status">Status</th>
                        <th data-i18n="admin_testimonial_order">Order</th>
                        <th data-i18n="admin_actions">Actions</th>
                    </tr>
                </thead>
                <tbody id="testimonialsTable">
                    <tr><td colspan="8" class="loading" data-i18n="admin_loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Add/Edit Testimonial Modal -->
    <div class="modal" id="testimonialModal">
        <div class="modal-content">
            <h2 class="modal-title" id="modalTitle" data-i18n="admin_testimonial_modal_add">Add Testimonial</h2>
            <form id="testimonialForm" onsubmit="saveTestimonial(event)">
                <input type="hidden" id="testimonialId">

                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="admin_testimonial_name_label">Name *</label>
                        <input type="text" id="name" placeholder="John Doe" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="admin_testimonial_role_label">Role / Title</label>
                        <input type="text" id="role" placeholder="Amazon FBA Seller">
                    </div>
                </div>

                <div class="form-group">
                    <label data-i18n="admin_testimonial_text_label">Comment *</label>
                    <textarea id="text" rows="4" placeholder="This tool is amazing..." required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="admin_testimonial_rating_label">Rating (1-5)</label>
                        <select id="rating">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (3)</option>
                            <option value="2">‚≠ê‚≠ê (2)</option>
                            <option value="1">‚≠ê (1)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="admin_testimonial_order_label">Sort Order</label>
                        <input type="number" id="sortOrder" value="0" placeholder="0">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-check">
                        <input type="checkbox" id="isActive" checked>
                        <span data-i18n="admin_testimonial_active_label">Active (show on homepage)</span>
                    </label>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal()" data-i18n="admin_cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-i18n="admin_testimonial_save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../assets/js/i18n.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
        const API = '/api';
        const token = AuthHelper.getToken();
        const user = AuthHelper.getUser() || {};

        if (!token || user.role !== 'admin') {
            window.location.href = '/login.html';
        }
        AuthHelper.startTokenRefresh();

        let testimonialsData = [];

        // Load testimonials
        async function loadTestimonials() {
            try {
                const r = await fetch(API + '/admin.php?action=testimonials', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await r.json();

                if (data.success && data.data.testimonials) {
                    testimonialsData = data.data.testimonials;

                    if (testimonialsData.length === 0) {
                        document.getElementById('testimonialsTable').innerHTML =
                            `<tr><td colspan="8" class="empty">No testimonials yet. Click "Add Testimonial" to create one.</td></tr>`;
                        return;
                    }

                    let html = '';
                    for (const t of testimonialsData) {
                        const stars = '‚≠ê'.repeat(parseInt(t.rating) || 5);
                        const statusText = t.is_active == 1 ? 'Active' : 'Inactive';
                        html += `
                            <tr>
                                <td><div class="avatar-preview">${esc(t.avatar || t.name.charAt(0))}</div></td>
                                <td><strong>${esc(t.name)}</strong></td>
                                <td>${esc(t.role || '-')}</td>
                                <td class="testimonial-text">${esc(t.text)}</td>
                                <td class="stars">${stars}</td>
                                <td><span class="badge ${t.is_active == 1 ? 'green' : 'red'}">${statusText}</span></td>
                                <td>${t.sort_order || 0}</td>
                                <td>
                                    <button class="btn btn-outline btn-sm" onclick="editTestimonial(${t.id})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteTestimonial(${t.id})">Delete</button>
                                </td>
                            </tr>
                        `;
                    }
                    document.getElementById('testimonialsTable').innerHTML = html;
                } else {
                    document.getElementById('testimonialsTable').innerHTML =
                        '<tr><td colspan="8" class="empty">Error: ' + (data.message || 'Unknown error') + '</td></tr>';
                }
            } catch (e) {
                console.error('Load error:', e);
                document.getElementById('testimonialsTable').innerHTML =
                    '<tr><td colspan="8" class="empty">Connection error.</td></tr>';
            }
        }

        // Open modal for new testimonial
        function openModal() {
            document.getElementById('modalTitle').textContent = 'Add Testimonial';
            document.getElementById('testimonialForm').reset();
            document.getElementById('testimonialId').value = '';
            document.getElementById('isActive').checked = true;
            document.getElementById('rating').value = '5';
            document.getElementById('sortOrder').value = '0';
            document.getElementById('testimonialModal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('testimonialModal').classList.remove('active');
        }

        // Edit testimonial
        function editTestimonial(id) {
            const t = testimonialsData.find(x => x.id == id);
            if (!t) return;

            document.getElementById('modalTitle').textContent = 'Edit Testimonial';
            document.getElementById('testimonialId').value = t.id;
            document.getElementById('name').value = t.name || '';
            document.getElementById('role').value = t.role || '';
            document.getElementById('text').value = t.text || '';
            document.getElementById('rating').value = t.rating || 5;
            document.getElementById('sortOrder').value = t.sort_order || 0;
            document.getElementById('isActive').checked = t.is_active == 1;

            document.getElementById('testimonialModal').classList.add('active');
        }

        // Delete testimonial
        async function deleteTestimonial(id) {
            if (!confirm('Are you sure you want to delete this testimonial?')) return;

            try {
                const r = await fetch(API + '/admin.php?action=testimonial_delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ id })
                });

                const result = await r.json();

                if (result.success) {
                    loadTestimonials();
                } else {
                    alert('Error: ' + (result.message || 'Failed to delete'));
                }
            } catch (e) {
                console.error('Delete error:', e);
                alert('Connection error: ' + e.message);
            }
        }

        // Save testimonial
        async function saveTestimonial(e) {
            e.preventDefault();

            const data = {
                id: document.getElementById('testimonialId').value || null,
                name: document.getElementById('name').value.trim(),
                role: document.getElementById('role').value.trim(),
                text: document.getElementById('text').value.trim(),
                rating: parseInt(document.getElementById('rating').value) || 5,
                sort_order: parseInt(document.getElementById('sortOrder').value) || 0,
                is_active: document.getElementById('isActive').checked ? 1 : 0
            };

            try {
                const r = await fetch(API + '/admin.php?action=testimonial_save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(data)
                });

                const result = await r.json();

                if (result.success) {
                    closeModal();
                    loadTestimonials();
                    alert('Testimonial saved successfully!');
                } else {
                    alert('Error: ' + (result.message || 'Failed to save'));
                }
            } catch (e) {
                console.error('Save error:', e);
                alert('Connection error: ' + e.message);
            }
        }

        // Escape HTML
        function esc(s) {
            return String(s || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // Logout
        function logout() { AuthHelper.logout(); }

        // Close modal on outside click
        document.getElementById('testimonialModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Load on start
        loadTestimonials();
    </script>
</body>
</html>
