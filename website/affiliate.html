<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affiliate Panel - ASIN Scout Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#0a0a0f;--bg2:#12121a;--bg3:#1a1a25;--text:#f0f0f5;--text2:#9898a8;--text3:#5a5a6e;--orange:#ff6b2c;--green:#22c97a;--blue:#4d8eff;--red:#ff4d5e;--purple:#7c5ce0;--border:#2a2a35}
        body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text)}
        .sidebar{position:fixed;left:0;top:0;bottom:0;width:250px;background:var(--bg2);border-right:1px solid var(--border);padding:20px;display:flex;flex-direction:column}
        .sidebar-logo{display:flex;align-items:center;gap:10px;font-size:18px;font-weight:800;margin-bottom:40px;text-decoration:none;color:var(--text)}
        .sidebar-logo span{color:var(--orange)}
        .sidebar-logo .icon{width:36px;height:36px;background:linear-gradient(135deg,#ff2c6b,var(--orange));border-radius:10px;display:flex;align-items:center;justify-content:center}
        .sidebar-menu{list-style:none;flex:1}
        .sidebar-menu a{display:block;padding:12px 16px;color:var(--text2);text-decoration:none;border-radius:10px;margin-bottom:4px;font-size:14px}
        .sidebar-menu a:hover,.sidebar-menu a.active{background:var(--bg3);color:var(--text)}
        .sidebar-menu a.active{color:var(--orange)}
        .sidebar-user{border-top:1px solid var(--border);padding-top:20px;display:flex;align-items:center;gap:12px}
        .sidebar-user .avatar{width:36px;height:36px;background:var(--purple);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px}
        .sidebar-user .name{font-size:13px;font-weight:600}
        .sidebar-user .email{font-size:11px;color:var(--text3)}
        .main{margin-left:250px;padding:30px}
        .page-title{font-size:28px;font-weight:700;margin-bottom:8px}
        .page-subtitle{font-size:14px;color:var(--text2);margin-bottom:30px}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:30px}
        .stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:20px}
        .stat-card .label{font-size:12px;color:var(--text2);margin-bottom:6px}
        .stat-card .value{font-size:28px;font-weight:800}
        .stat-card .value.green{color:var(--green)}
        .stat-card .value.orange{color:var(--orange)}
        .stat-card .value.blue{color:var(--blue)}
        .stat-card .value.purple{color:var(--purple)}
        .card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .card-title{font-size:18px;font-weight:600}
        .link-box{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
        .link-box code{font-size:13px;color:var(--purple);word-break:break-all}
        .link-box button{background:var(--purple);color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer}
        .link-box button:hover{opacity:0.9}
        table{width:100%;border-collapse:collapse}
        th,td{text-align:left;padding:12px;border-bottom:1px solid var(--border);font-size:13px}
        th{color:var(--text2);font-size:11px;text-transform:uppercase;background:var(--bg3)}
        tr:hover{background:var(--bg3)}
        .badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600}
        .badge.green{background:rgba(34,201,122,0.15);color:var(--green)}
        .badge.orange{background:rgba(255,107,44,0.15);color:var(--orange)}
        .badge.blue{background:rgba(77,142,255,0.15);color:var(--blue)}
        .empty{text-align:center;padding:40px;color:var(--text2)}
        .tabs{display:flex;gap:4px;margin-bottom:20px}
        .tab{padding:10px 20px;background:transparent;border:1px solid var(--border);color:var(--text2);border-radius:8px;cursor:pointer;font-size:13px;font-weight:500}
        .tab:hover{border-color:var(--purple);color:var(--text)}
        .tab.active{background:linear-gradient(135deg,rgba(124,92,224,0.2),rgba(124,92,224,0.1));border-color:var(--purple);color:var(--purple)}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .mobile-toggle{display:none;position:fixed;top:12px;left:12px;z-index:1001;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-size:18px;cursor:pointer}
        .sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:999}
        @media(max-width:768px){.mobile-toggle{display:block}.sidebar{transform:translateX(-100%);transition:transform 0.3s;z-index:1000}.sidebar.open{transform:translateX(0)}.main{margin-left:0}.sidebar-overlay.active{display:block}.stats-grid{grid-template-columns:repeat(2,1fr)}}
        .loading{text-align:center;padding:60px;color:var(--text2)}
        .error-box{background:rgba(255,77,94,0.1);border:1px solid rgba(255,77,94,0.3);color:var(--red);padding:20px;border-radius:12px;text-align:center}
    </style>
</head>
<body>
<button class="mobile-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open');document.querySelector('.sidebar-overlay').classList.toggle('active')">&#9776;</button>
<div class="sidebar-overlay" onclick="document.querySelector('.sidebar').classList.remove('open');this.classList.remove('active')"></div>
    <aside class="sidebar">
        <a href="index.html" class="sidebar-logo"><div class="icon">A</div>ASIN<span>Scout</span></a>
        <ul class="sidebar-menu">
            <a href="dashboard.html">ğŸ“Š Dashboard</a>
            <a href="scans.html">ğŸ“ TaramalarÄ±m</a>
            <a href="affiliate.html" class="active">ğŸ¤ Affiliate</a>
            <a href="pricing.html">ğŸ’³ Paket Al</a>
            <a href="settings.html">âš™ï¸ Ayarlar</a>
            <a href="#" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ</a>
        </ul>
        <div class="sidebar-user">
            <div class="avatar" id="userAvatar">U</div>
            <div><div class="name" id="userName">User</div><div class="email" id="userEmail">...</div></div>
        </div>
    </aside>
    <main class="main">
        <h1 class="page-title">ğŸ¤ Affiliate Panel</h1>
        <p class="page-subtitle">Referans linkiniz ve kazanÃ§larÄ±nÄ±z</p>

        <div id="content">
            <div class="loading">YÃ¼kleniyor...</div>
        </div>
    </main>

    <script src="assets/js/auth.js"></script>
    <script>
        const API = '/api';
        const token = AuthHelper.getToken();
        if (!token) location.href = 'login.html';
        const user = AuthHelper.getUser() || {};
        AuthHelper.startTokenRefresh();
        document.getElementById('userName').textContent = user.name || 'User';
        document.getElementById('userEmail').textContent = user.email || '';
        document.getElementById('userAvatar').textContent = (user.name || 'U')[0].toUpperCase();

        async function loadAffiliate() {
            try {
                const r = await fetch(API + '/auth.php?action=affiliate_dashboard', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const d = await r.json();

                if (!d.success) {
                    document.getElementById('content').innerHTML = `
                        <div class="error-box">
                            <h3 style="margin-bottom:10px">Affiliate KaydÄ± BulunamadÄ±</h3>
                            <p>HesabÄ±nÄ±za baÄŸlÄ± bir affiliate kaydÄ± yok.</p>
                            <p style="margin-top:10px;font-size:12px;color:var(--text2)">Affiliate olmak iÃ§in bizimle iletiÅŸime geÃ§in.</p>
                        </div>
                    `;
                    return;
                }

                const { affiliate, stats, referrals, earnings } = d.data;
                renderDashboard(affiliate, stats, referrals, earnings);
            } catch (e) {
                document.getElementById('content').innerHTML = `<div class="error-box">BaÄŸlantÄ± hatasÄ±: ${e.message}</div>`;
            }
        }

        function renderDashboard(affiliate, stats, referrals, earnings) {
            document.getElementById('content').innerHTML = `
                <div class="card">
                    <div class="card-title" style="margin-bottom:12px">Referans Linkiniz</div>
                    <div class="link-box">
                        <code id="affLink">${esc(affiliate.link)}</code>
                        <button onclick="copyLink()">Kopyala</button>
                    </div>
                    <p style="font-size:12px;color:var(--text2);margin-top:8px">
                        Komisyon OranÄ±nÄ±z: <strong style="color:var(--green)">${affiliate.commission_rate}%</strong>
                        ${parseFloat(affiliate.user_discount || 0) > 0 ? ' | KullanÄ±cÄ± Ä°ndirimi: <strong style="color:var(--blue)">' + parseFloat(affiliate.user_discount).toFixed(1) + '%</strong>' : ''}
                    </p>
                    ${parseFloat(affiliate.user_discount || 0) > 0 ? '<p style="font-size:11px;color:var(--text3);margin-top:4px">Linkiniz ile kayÄ±t olan kullanÄ±cÄ±lar %' + parseFloat(affiliate.user_discount).toFixed(1) + ' indirim kazanÄ±r.</p>' : ''}
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">Toplam Referans</div>
                        <div class="value blue">${stats.total_referrals}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">SatÄ±ÅŸ SayÄ±sÄ±</div>
                        <div class="value orange">${stats.total_orders}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Toplam KazanÃ§</div>
                        <div class="value green">$${stats.total_earnings.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Bekleyen Ã–deme</div>
                        <div class="value purple">$${stats.pending_earnings.toFixed(2)}</div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab('referrals')">ReferanslarÄ±m</button>
                    <button class="tab" onclick="switchTab('earnings')">KazanÃ§larÄ±m</button>
                </div>

                <div class="tab-content active" id="tab-referrals">
                    <div class="card">
                        <div class="card-title">KayÄ±t Olan KullanÄ±cÄ±lar</div>
                        ${referrals.length > 0 ? `
                            <table>
                                <thead><tr><th>Ä°sim</th><th>E-posta</th><th>KayÄ±t Tarihi</th></tr></thead>
                                <tbody>
                                    ${referrals.map(r => `
                                        <tr>
                                            <td><strong>${esc(r.name)}</strong></td>
                                            <td style="color:var(--text2)">${esc(r.email)}</td>
                                            <td>${fmtDate(r.date)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<div class="empty">HenÃ¼z referans yok</div>'}
                    </div>
                </div>

                <div class="tab-content" id="tab-earnings">
                    <div class="card">
                        <div class="card-title">Komisyon GeÃ§miÅŸi</div>
                        ${earnings.length > 0 ? `
                            <table>
                                <thead><tr><th>Tarih</th><th>KullanÄ±cÄ±</th><th>Paket</th><th>Tutar</th><th>Komisyon</th><th>Durum</th></tr></thead>
                                <tbody>
                                    ${earnings.map(e => `
                                        <tr>
                                            <td>${fmtDate(e.date)}</td>
                                            <td><strong>${esc(e.user)}</strong></td>
                                            <td>${esc(e.package)}</td>
                                            <td>$${parseFloat(e.order_amount).toFixed(2)}</td>
                                            <td style="color:var(--green);font-weight:600">$${parseFloat(e.commission).toFixed(2)}</td>
                                            <td><span class="badge ${e.status === 'paid' ? 'green' : e.status === 'approved' ? 'blue' : 'orange'}">${e.status === 'paid' ? 'Ã–dendi' : e.status === 'approved' ? 'OnaylandÄ±' : 'Bekliyor'}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<div class="empty">HenÃ¼z kazanÃ§ yok</div>'}
                    </div>
                </div>
            `;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            event.target.classList.add('active');
        }

        function copyLink() {
            const link = document.getElementById('affLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                const btn = event.target;
                btn.textContent = 'KopyalandÄ±!';
                btn.style.background = 'var(--green)';
                setTimeout(() => {
                    btn.textContent = 'Kopyala';
                    btn.style.background = '';
                }, 2000);
            });
        }

        function logout() { AuthHelper.logout(); }
        function esc(s) { return String(s || '').replace(/</g, '&lt;'); }
        function fmtDate(d) { return d ? new Date(d).toLocaleDateString('tr-TR') : '-'; }

        loadAffiliate();
    </script>
</body>
</html>
